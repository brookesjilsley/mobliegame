<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ABI 6TH FORM: THE GAME</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        :root {
            --bg-color: #101015;
            --ui-bg: #ffffff;
            --ui-border: #404040;
            --text-color: #000000;
            --accent: #f0db4f;
            --danger: #ff4444;
            --success: #44ff44;
        }
        body {
            background-color: #050505;
            color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
            margin: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            display: flex;
            flex-direction: column;
        }

        #game-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        #screen-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #111;
            padding: 2px;
            overflow: hidden;
            position: relative;
        }

        #game-container {
            position: relative;
            aspect-ratio: 4/3;
            width: 100%;
            max-height: 100%;
            max-width: 100vh;
            background-color: var(--bg-color);
            border: 2px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            outline: none;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        #mobile-controls {
            height: auto;
            min-height: 220px;
            background: #222;
            border-top: 4px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
            z-index: 1000;
            touch-action: none;
            padding-bottom: env(safe-area-inset-bottom);
        }

        @media (orientation: landscape) and (max-height: 500px) {
            #mobile-controls {
                position: absolute;
                bottom: 0;
                width: 100%;
                background: transparent;
                border: none;
                pointer-events: none;
                min-height: 0;
                padding-bottom: 20px;
            }
            .dpad, .action-btn-container {
                pointer-events: auto;
                background: rgba(0,0,0,0.5);
                border-radius: 20px;
                padding: 10px;
            }
        }

        .dpad {
            display: grid;
            grid-template-columns: 60px 60px 60px;
            grid-template-rows: 60px 60px;
            gap: 5px;
            touch-action: none;
        }
        
        .dpad-btn {
            width: 60px;
            height: 60px;
            background: #444;
            border-bottom: 4px solid #222;
            border-radius: 8px;
            color: #aaa;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 4px 0 #111;
            cursor: pointer;
            touch-action: none;
        }
        .dpad-btn.active {
            background: #666;
            transform: translateY(4px);
            box-shadow: 0 0 0 #111;
            border-bottom: none;
        }

        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }

        .action-btn-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #btn-action {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #d82020;
            border: 4px solid #900;
            box-shadow: 0 6px 0 #500;
            color: white;
            font-size: 24px;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            cursor: pointer;
        }
        #btn-action.active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #500;
        }

        #intro-screen {
            position: absolute;
            top:0; left:0; width:100%; height:100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
            color: white;
            overflow: hidden;
        }
        .glitch-title {
            font-size: 30px;
            position: relative;
            color: #44ff44;
            text-shadow: 4px 4px #000;
            margin-bottom: 10px;
            animation: glitch 1s infinite;
        }
        .glitch-title::before, .glitch-title::after {
            content: "ABI 6TH FORM";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; background: #000;
        }
        .glitch-title::before {
            left: 2px; text-shadow: -2px 0 #ff00c1; clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim-1 5s infinite linear alternate-reverse;
        }
        .glitch-title::after {
            left: -2px; text-shadow: -2px 0 #00fff9; clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim-2 5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim-1 {
            0% { clip: rect(30px, 9999px, 10px, 0); }
            20% { clip: rect(80px, 9999px, 90px, 0); }
            40% { clip: rect(10px, 9999px, 50px, 0); }
            60% { clip: rect(40px, 9999px, 20px, 0); }
            80% { clip: rect(70px, 9999px, 90px, 0); }
            100% { clip: rect(20px, 9999px, 60px, 0); }
        }
        @keyframes glitch-anim-2 {
            0% { clip: rect(10px, 9999px, 30px, 0); }
            20% { clip: rect(50px, 9999px, 20px, 0); }
            40% { clip: rect(90px, 9999px, 70px, 0); }
            60% { clip: rect(20px, 9999px, 40px, 0); }
            80% { clip: rect(60px, 9999px, 10px, 0); }
            100% { clip: rect(80px, 9999px, 90px, 0); }
        }
        .subtitle { font-size: 10px; color: #ccc; margin-bottom: 20px; letter-spacing: 2px; }
        .mission-box { border: 2px solid #44ff44; padding: 10px; background: rgba(0, 50, 0, 0.8); margin-bottom: 20px; width: 80%; }
        .press-start { font-size: 14px; color: #f0db4f; animation: blinker 0.8s linear infinite; cursor: pointer; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        #focus-overlay {
            position: absolute;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            cursor: pointer;
            color: #4f4;
            flex-direction: column;
            text-align: center;
            touch-action: none;
        }
        #dialogue-box {
            position: absolute; display: none; bottom: 10px; left: 10px; right: 10px; height: 100px; z-index: 10;
            padding: 10px; border: 4px double #000; background-color: #fff; border-radius: 4px; line-height: 1.6; font-size: 12px; color: black;
        }
        #dialogue-name { color: #d00; margin-bottom: 5px; text-transform: uppercase; font-size: 12px; }
        #room-name {
            position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border: 2px solid white; display: none;
        }
        #scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 999; opacity: 0.3;
        }
        .logo-box {
            border: 4px solid #fff; padding: 15px 20px; background: #000; margin-bottom: 40px; box-shadow: 6px 6px 0px #444;
            display: flex; flex-direction: column; align-items: center; transform: scale(1.2);
        }
        .logo-jbr { font-size: 40px; color: #f0db4f; text-shadow: 4px 4px 0px #d82020; line-height: 1; font-weight: bold; }
        .logo-games { font-size: 12px; color: #44ff44; letter-spacing: 8px; margin-top: 5px; border-top: 2px solid #333; padding-top: 5px; width: 100%; text-align: center; }
    </style>
</head>
<body>
<div id="game-wrapper">
    <div id="screen-area">
        <div id="game-container" tabindex="0">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <div id="scanlines"></div>
            <div id="room-name">COMMON ROOM</div>
            
            <div id="focus-overlay">
                <div class="logo-box"><div class="logo-jbr">JBR</div><div class="logo-games">GAMES</div></div>
                <div class="blink" style="color:#f0db4f">Tap to Start</div>
            </div>
            <div id="intro-screen">
                <div class="glitch-title">ABI 6TH FORM</div>
                <div class="subtitle">THE GAME</div>
                <div class="mission-box">
                    <p style="color:#ff4444; margin-bottom:10px;">ALERT: BUG RELEASE</p>
                    <p style="font-size: 8px; line-height: 1.5;">
                        The Main Glitch has stolen the JCQ Exam and AI guidance.<br>
                        You need to recover it so you can spread good practice.<br><br>
                        CONTROLS:<br>Use Buttons Below
                    </p>
                </div>
                <div class="press-start">TAP 'A' BUTTON</div>
            </div>
            <div id="dialogue-box">
                <div id="dialogue-name">System</div><div id="dialogue-text">...</div>
                <div style="font-size: 10px; text-align: right; margin-top: 10px; opacity: 0.7;">[A]</div>
            </div>
        </div>
    </div>
    <div id="mobile-controls">
        <div class="control-group dpad">
            <div class="dpad-btn" id="btn-up">▲</div>
            <div class="dpad-btn" id="btn-left">◀</div>
            <div class="dpad-btn" id="btn-down">▼</div>
            <div class="dpad-btn" id="btn-right">▶</div>
        </div>
        <div class="control-group action-btn-container">
            <div id="btn-action">A</div>
        </div>
    </div>
</div>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- GLOBAL CONSTANTS ---
const TILE_SIZE = 40;
const COLS = 20;
const ROWS = 15;
const COLORS = { 
    floor: '#222', wall: '#444', 
    mediaFloor: '#203020', libraryFloor: '#202040', examFloor: '#302020',
    astroFloor: '#38761d', pastoralFloor: '#2a3b4c', dtFloor: '#3d3d3d',
    rsFloor: '#4b3621' // Dark wood/brown for RS
};

// --- PIXEL ART SPRITE SYSTEM ---
const PALETTE = {
    '.': null, 'x': '#000000', 's': '#ffccaa', 'w': '#ffffff', 'r': '#d82020',
    'b': '#2040d8', 'g': '#44aa44', 'y': '#ffee00', 'h': '#663300',
    'c': '#888888', 'p': '#aa00aa', 'm': '#00aa00', 'd': '#222222',
    'D': '#664400', 'T': '#8b4513', 'C': '#666666', 'L': '#228b22', 'O': '#ff9900',
    'S': '#d2a679' // Added darker skin tone for Miss Patel
};
const SPRITE_DATA = {
    player: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xppppppx.....","..xppppppppx....", ".xppwwwwwwppx...", ".xppwwwwwwppx...", ".xppppppppppx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    grant: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhsxwwxshx....", "..xhsssssshx....", "....xxxxxx......", "...xrrwwrrx.....","..xrrwwwwrrx....", ".xrrwwwwwwrrx...", ".xrrwwwwwwrrx...", ".xrrrrrrrrrrx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    brookes: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.ww.shx....", "..xhhhhhhhhx....", "....xxxxxx......", "...xggggggx.....","..xggggggggx....", ".xggccccccggx...", ".xggccccccggx...", ".xggggggggggx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    botwright: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xccccccx.....","..xccwwwwccx....", ".xccwwrrwwccx...", ".xccwwrrwwccx...", ".xccccccccccx...","..xddddddddx....", "..xddddddddx....", "...xx....xx.....", "...xx....xx....."],
    mcmahon: ["....xxxxxx......", "...xyyyyyyx.....", "..xyyyyyyyyx....", "..xyssxxssyx....","..xys.xx.syx....", "..xyssssssyx....", "....xxxxxx......", "...xppppppx.....","..xppppppppx....", ".xppwwwwwwppx...", ".xppwwwwwwppx...", ".xppppppppppx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    oneill: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xbbbbbbx.....","..xbbbbbbbbx....", ".xbbwwwwwwbbx...", ".xbbwwyywwbbx...", ".xbbbbbbbbbbx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    oneill_strict: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xrrrrrrx.....","..xrrrrrrrrx....", ".xrrwwwwwwrrx...", ".xrrwwwwwwrrx...", ".xrrrrrrrrrrx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    julie: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xwwwwwwx.....","..xwwwwwwwwx....", ".xwwwwwwwwwwx...", ".xwwwwwwwwwwx...", ".xwwwwwwwwwwx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    deacon: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xddddddx.....","..xddddddddx....", ".xddddwwddddx...", ".xddddwwddddx...", ".xddddddddddx...","..xddddddddx....", "..xddddddddx....", "...xx....xx.....", "...xx....xx....."],
    jones: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xTTTTTTx.....","..xTTTTTTTTx....", ".xTTTTTTTTTTx...", ".xTTwwwwwwTTx...", ".xTTTTTTTTTTx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    russell: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xwwwwwwx.....","..xwwwwwwwwx....", ".xwwwwwwwwwwx...", ".xwwbbwwbbwwx...", ".xwwwwwwwwwwx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    mckeown: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhsxwwxshx....", "..xhsssssshx....", "....xxxxxx......", "...xppppppx.....","..xppppppppx....", ".xppwwwwwwppx...", ".xppwwwwwwppx...", ".xppppppppppx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    clinton: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xddddddx.....","..xddddddddx....", ".xddddddddddx...", ".xddwwwwwdddx...", ".xddddddddddx...","..xddddddddx....", "..xddddddddx....", "...xx....xx.....", "...xx....xx....."],
    mcdonald: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xyyyyyyx.....","..xyyyyyyyyx....", ".xyywwwwwwyyx...", ".xyywwwwwwyyx...", ".xyyyyyyyyyyx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    lakin: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xddddddx.....","..xddddddddx....", ".xddwwwwwwddx...", ".xddwwwwwwddx...", ".xddddddddddx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    hemmings: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xDDDDDDx.....","..xDDDDDDDDx....", ".xDDwwwwwwDDx...", ".xDDwwwwwwDDx...", ".xDDDDDDDDDDx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    pearson: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xppppppx.....","..xppppppppx....", ".xppwwwwwwppx...", ".xppwwwwwwppx...", ".xppppppppppx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    patel: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhSSxxSShx....","..xhS.xx.Shx....", "..xhSSSSSShx....", "....xxxxxx......", "...xOOOOOOx.....","..xOOOOOOOOx....", ".xOOwwwwwwOOx...", ".xOOwwwwwwOOx...", ".xOOOOOOOOOOx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    herron: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xyyyyyyx.....","..xyyyyyyyyx....", ".xyywwwwwwyyx...", ".xyywwwwwwyyx...", ".xyyyyyyyyyyx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    rose: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xrrrrrrx.....","..xrrrrrrrrx....", ".xrrwwwwwwrrx...", ".xrrwwwwwwrrx...", ".xrrrrrrrrrrx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    blair: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xCCCCCCx.....","..xCCCCCCCCx....", ".xCCwwwwwwCCx...", ".xCCwwwwwwCCx...", ".xCCCCCCCCCCx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    student: ["....xxxxxx......", "...xhhhhhhx.....", "..xhhhhhhhhx....", "..xhssxxsshx....","..xhs.xx.shx....", "..xhsssssshx....", "....xxxxxx......", "...xbbbbbbx.....","..xbbbbbbbbx....", ".xbbwwwwwwbbx...", ".xbbwwwwwwbbx...", ".xbbbbbbbbbbx...","..xccccccccx....", "..xccccccccx....", "...xx....xx.....", "...xx....xx....."],
    student_kneeling: ["................", "................", "....xxxxxx......", "...xhhhhhhx.....","..xhhhhhhhhx....", "..xhsssssshx....", "..xhsssssshx....", "..xhsssssshx....","....xxxxxx......", "...xbbbbbbx.....", "..xbbbbbbbbx....", ".xbbwwwwwwbbx...","..xbbwwwwwwbbx..", "..xbbbbbbbbbbx..", "...xccccccccx...", "...xccccccccx..."],
    ball: ["................", "................", "................", "................","................", "................", "................", "................","......xxxx......", "....xxwwwwxx....", "...xwwxwwxwwx...","...xwxxxxxxwx...", "...xwwxwwxwwx...", "....xxwwwwxx....", "......xxxx......", "................"],
    computer: ["................", "................", "...xxxxxxxxxx...", "...x.bbbbbb.x...","...x.bbbbbb.x...", "...x.bbbbbb.x...", "...xxxxxxxxxx...", "......xxxx......","...xxxxxxxxxx...", "...xxxxxxxxxx...", "................", "................","................", "................", "................", "................"],
    glitch: ["....mmmmmm......", "...mm.mm.mm.....", "..mmmmmmmmmm....", "..m.m.mm.m.m....","..mmmmmmmmmm....", "..m.mmmmmm.m....", "....mmmmmm......", "...mxmxmxmx.....","..mxmxmxmxmx....", ".xmxmxmxmxmxm...", ".mxmxmxmxmxmx...", ".xmxmxmxmxmxm...","..xmxmxmxmx.....", "..mxmxmxmxm.....", "...m......m.....", "...m......m....."],
    bug: ["................", "................", "................", "................","......mm........", "....mmmmmm......", "...mmxmmxmm.....", "...mmmmmmmm.....","....mmmmmm......", "....m....m......", "....m....m......", "................","................", "................", "................", "................"],
    door: ["xxxxx......xxxxx", "xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx","xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx","xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx","xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx", "xDDDx......xDDDx"],
    chair: ["................", "................", "................", "................","......xxxx......", "......xOOx......", "......xOOx......", "......xOOx......","......xOOx......", "....xxxOOxxx....", "...xOOOOOOOOx...", "...xOOOOOOOOx...","...xOOOOOOOOx...", "...xxxxxxxxxx...", "...x.x....x.x...", "...x.x....x.x..."],
    table: ["................", "................", "................", "................","................", "................", "................", "................",".xxxxxxxxxxxxxx.", ".xTTTTTTTTTTTTx.", ".xTTTTTTTTTTTTx.", ".xTTTTTTTTTTTTx.",".xTTTTTTTTTTTTx.", ".xxxxxxxxxxxxxx.", ".xx..........xx.", ".xx..........xx."],
    plant: ["................", "......LLLL......", "....LLLLLLLL....", "...LLLLLLLLLL...","..LLLLLLLLLLLL..", "..LLLLLLLLLLLL..", "..LLLLLLLLLLLL..", "...LLLLLLLLLL...","....LLLLLLLL....", "......LLLL......", ".......xx.......", "......xDDx......","......xDDx......", "......xDDx......", "......xDDx......", "......xxxx......"],
    alert: ["................", ".......OO.......", "......OOOO......", "......OOOO......","......OOOO......", "......OOOO......", ".......OO.......", ".......OO.......",".......OO.......", "................", ".......OO.......", "......OOOO......",".......OO.......", "................", "................", "................"]
};
function drawSprite(ctx, key, x, y, size, facingRight = true, bob = 0, opacity = 1.0) {
    const data = SPRITE_DATA[key];
    if (!data) return;
    const pixelSize = size / 16;
    const bobOffset = Math.sin(bob) * 2; 
    ctx.globalAlpha = opacity;
    for (let r = 0; r < 16; r++) {
        for (let c = 0; c < 16; c++) {
            let char = data[r][c];
            if (char !== '.') {
                ctx.fillStyle = PALETTE[char];
                let drawX = facingRight ? x + (15 - c) * pixelSize : x + c * pixelSize;
                let drawY = y + r * pixelSize + bobOffset;
                ctx.fillRect(drawX, drawY, pixelSize, pixelSize);
            }
        }
    }
    ctx.globalAlpha = 1.0;
}
function wrapText(context, text, x, y, maxWidth, lineHeight) {
    if (!text) return;
    const words = text.split(' ');
    let line = '';
    for(let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = context.measureText(testLine);
        if (metrics.width > maxWidth && n > 0) {
            context.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
        }
        else line = testLine;
    }
    context.fillText(line, x, y);
}
// --- AUDIO SYSTEM ---
let audioCtx, bgmOscillators = [], isMuted = false, currentSong = 'NONE'; 
let battleInit = false, battleLead, battleBass, battleKick, battleNoise, battleLeadSeq, battleBassSeq, battleDrumSeq;
let townInit = false, townSynth, townBass, townMelodySeq, townBassSeq;
let chapelInit = false, chapelSynth, chapelMelodySeq;
let victoryMusicInit = false, victoryMusicSynth, victoryMusicBass, victoryMelodySeq, victoryBassSeq;
let enemyDownInit = false, downNoise, downHit;
let encounterInit = false, encounterSynth;
let victoryInit = false, victorySynth;

function initVictoryFanfare() {
    if (victoryInit) return;
    victorySynth = new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.01,decay:0.1,sustain:0.3,release:0.2}}).toDestination();
    victorySynth.volume.value = -8;
    victoryInit = true;
}
function playVictoryFanfare() {
    if (Tone.context.state !== 'running') return;
    initVictoryFanfare();
    const now = Tone.now();
    const melody = [{note:"C5",time:0,duration:"8n"},{note:"E5",time:0.15,duration:"8n"},{note:"G5",time:0.3,duration:"8n"},{note:"C6",time:0.45,duration:"4n"},{note:"G5",time:0.75,duration:"16n"},{note:"C6",time:0.85,duration:"4n"}];
    melody.forEach(({note, time, duration}) => victorySynth.triggerAttackRelease(note, duration, now + time));
}
function initEncounterSfx() {
  if (encounterInit) return;
  encounterSynth = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.001,decay:0.1,sustain:0.3,release:0.1}}).toDestination();
  encounterSynth.volume.value = -8;
  encounterInit = true;
}
function playEncounterSfx() {
  if (Tone.context.state !== 'running') return;
  initEncounterSfx();
  const now = Tone.now();
  const siren = [{note:"E5",time:0},{note:"C5",time:0.15},{note:"E5",time:0.3},{note:"C5",time:0.45},{note:"E5",time:0.6},{note:"C5",time:0.75},{note:"E5",time:0.9},{note:"C5",time:1.05},{note:"G5",time:1.2},{note:"C6",time:1.35}];
  siren.forEach(({note, time}) => encounterSynth.triggerAttackRelease(note, "8n", now + time));
}
function initEnemyDownSfx() {
  if (enemyDownInit) return;
  downNoise = new Tone.NoiseSynth({noise:{type:"white"},envelope:{attack:0.001,decay:0.45,sustain:0}}).toDestination(); downNoise.volume.value = -8;
  downHit = new Tone.Synth({oscillator:{type:"square"},envelope:{attack:0.001,decay:0.2,sustain:0,release:0.1}}).toDestination(); downHit.volume.value = -6;
  enemyDownInit = true;
}
function playEnemyDownSfx() {
  if (Tone.context.state !== 'running') return;
  initEnemyDownSfx();
  const now = Tone.now();
  downNoise.triggerAttackRelease("4n", now);
  ["C3", "G2", "C2"].forEach((n, i) => downHit.triggerAttackRelease(n, "16n", now + 0.15 + i*0.08));
  downHit.triggerAttackRelease("C1", "8n", now + 0.45);
}
async function initAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    try {
        await Tone.start();
        playMusic('ROAM');
    } catch(e) { console.log("Audio init failed", e); }
}
function initTownMusic() {
  if (townInit) return;
  // Use PolySynth to prevent envelope interruption errors
  townSynth = new Tone.PolySynth(Tone.Synth, {oscillator:{type:"triangle"},envelope:{attack:0.02,decay:0.1,sustain:0.3,release:0.5}}).toDestination(); 
  townSynth.volume.value = -10; 
  townBass = new Tone.PolySynth(Tone.Synth, {oscillator:{type:"square"},envelope:{attack:0.05,decay:0.2,sustain:0.5,release:0.5}}).toDestination(); 
  townBass.volume.value = -8;
  townMelodySeq = new Tone.Sequence((t, n) => { if (n) townSynth.triggerAttackRelease(n, "8n", t); }, ["C5", null, "E5", "G5", "A5", "G5", "E5", "C5", "D5", null, "F5", "A5", "G5", "F5", "D5", "B4"], "8n");
  townBassSeq = new Tone.Sequence((t, n) => { if (n) townBass.triggerAttackRelease(n, "8n", t); }, ["C3", null, "C3", null, "F3", null, "F3", null, "G3", null, "G3", null, "C3", null, "C3", null], "4n");
  townMelodySeq.loop = true; townBassSeq.loop = true; townInit = true;
}
function initChapelMusic() {
    if (chapelInit) return;
    chapelSynth = new Tone.PolySynth(Tone.Synth, {oscillator:{type:"sine"},envelope:{attack:0.5,decay:1,sustain:0.8,release:1}}).toDestination(); chapelSynth.volume.value = -12;
    chapelMelodySeq = new Tone.Sequence((t, notes) => { if (notes) chapelSynth.triggerAttackRelease(notes, "2n", t); }, [["C4", "E4", "G4"], null, ["F4", "A4", "C5"], null, ["G4", "B4", "D5"], null, ["C4", "E4", "G4"], null], "2n");
    chapelMelodySeq.loop = true; chapelInit = true;
}
function initVictoryMusic() {
    if (victoryMusicInit) return;
    // Use PolySynth
    victoryMusicSynth = new Tone.PolySynth(Tone.Synth, {oscillator:{type:"triangle"},envelope:{attack:0.01,decay:0.1,sustain:0.4,release:0.3}}).toDestination(); 
    victoryMusicSynth.volume.value = -10;
    victoryMusicBass = new Tone.PolySynth(Tone.Synth, {oscillator:{type:"square"},envelope:{attack:0.05,decay:0.2,sustain:0.5,release:0.5}}).toDestination(); 
    victoryMusicBass.volume.value = -8;
    victoryMelodySeq = new Tone.Sequence((t, n) => { if (n) victoryMusicSynth.triggerAttackRelease(n, "8n", t); }, ["C5", "E5", "G5", "C6", "G5", "E5", "C5", "E5", "D5", "F5", "A5", "D6", "A5", "F5", "D5", "F5", "E5", "G5", "C6", "E6", "C6", "G5", "E5", "G5", "C5", "E5", "G5", "C6", null, null, null, null], "8n");
    victoryBassSeq = new Tone.Sequence((t, n) => { if (n) victoryMusicBass.triggerAttackRelease(n, "8n", t); }, ["C3", "C3", "C3", "C3", "F3", "F3", "F3", "F3", "G3", "G3", "G3", "G3", "C3", "C3", "C3", "C3"], "4n");
    victoryMelodySeq.loop = true; victoryBassSeq.loop = true; victoryMusicInit = true;
}
function initBattleMusic() {
  if (battleInit) return;
  // Use PolySynth
  battleLead = new Tone.PolySynth(Tone.Synth, {oscillator:{type:"square"},envelope:{attack:0.01,decay:0.1,sustain:0.3,release:0.2}}).toDestination(); 
  battleLead.volume.value = -10; 
  battleBass = new Tone.PolySynth(Tone.Synth, {oscillator:{type:"square"},envelope:{attack:0.01,decay:0.1,sustain:0.4,release:0.2}}).toDestination(); 
  battleBass.volume.value = -8;
  battleKick = new Tone.MembraneSynth().toDestination(); battleKick.volume.value = -6;
  battleNoise = new Tone.NoiseSynth({noise:{type:"white"},envelope:{attack:0.001,decay:0.12,sustain:0}}).toDestination(); battleNoise.volume.value = -12;
  battleBassSeq = new Tone.Sequence((t, n) => { if (n) battleBass.triggerAttackRelease(n, "8n", t); }, ["C2", "C2", "C2", "C2", "Ab1", "Ab1", "Ab1", "Ab1", "Bb1", "Bb1", "Bb1", "Bb1", "G1", "G1", "G1", "G1"], "8n");
  const leadA = ["C5", null, "Eb5", null, "G5", null, "F5", null, "Eb5", null, "D5", null, "C5", null, null, null];
  const leadB = ["G5", null, "F5", null, "Eb5", null, "C5", null, "Bb4", null, "C5", null, "D5", null, null, null];
  battleLeadSeq = new Tone.Sequence((t, n) => { if (n) battleLead.triggerAttackRelease(n, "16n", t); }, [...leadA,...leadA,...leadB,...leadA], "16n");
  battleDrumSeq = new Tone.Sequence((t, h) => { if (h === "K") battleKick.triggerAttackRelease("C1", "16n", t); }, ["K", null, null, null, "K", null, null, null, "K", null, null, null, "K", null, null, null], "16n");
  battleBassSeq.loop = true; battleLeadSeq.loop = true; battleDrumSeq.loop = true; battleInit = true;
}
function stopAllMusic() {
    if (battleBassSeq) { battleBassSeq.dispose(); battleBassSeq = null; } if (battleLeadSeq) { battleLeadSeq.dispose(); battleLeadSeq = null; } if (battleDrumSeq) { battleDrumSeq.dispose(); battleDrumSeq = null; }
    if (battleLead) { battleLead.dispose(); battleLead = null; } if (battleBass) { battleBass.dispose(); battleBass = null; } if (battleKick) { battleKick.dispose(); battleKick = null; } if (battleNoise) { battleNoise.dispose(); battleNoise = null; }
    battleInit = false;
    if (townMelodySeq) { townMelodySeq.dispose(); townMelodySeq = null; } if (townBassSeq) { townBassSeq.dispose(); townBassSeq = null; } if (townSynth) { townSynth.dispose(); townSynth = null; } if (townBass) { townBass.dispose(); townBass = null; }
    townInit = false;
    if (chapelMelodySeq) { chapelMelodySeq.dispose(); chapelMelodySeq = null; } if (chapelSynth) { chapelSynth.dispose(); chapelSynth = null; }
    chapelInit = false;
    if (victoryMelodySeq) { victoryMelodySeq.dispose(); victoryMelodySeq = null; } if (victoryBassSeq) { victoryBassSeq.dispose(); victoryBassSeq = null; } if (victoryMusicSynth) { victoryMusicSynth.dispose(); victoryMusicSynth = null; } if (victoryMusicBass) { victoryMusicBass.dispose(); victoryMusicBass = null; }
    victoryMusicInit = false;
    try { Tone.Transport.stop(); Tone.Transport.cancel(); Tone.Transport.position = 0; } catch(e) { console.log("Error stopping transport:", e); }
    currentSong = 'NONE';
}
async function startBattleMusic() { if (Tone.context.state !== 'running') await Tone.start(); Tone.Transport.bpm.value = 150; initBattleMusic(); battleBassSeq.start(0); battleLeadSeq.start(0); battleDrumSeq.start(0); Tone.Transport.start(); }
async function startTownMusic() { if (Tone.context.state !== 'running') await Tone.start(); Tone.Transport.bpm.value = 120; initTownMusic(); townMelodySeq.start(0); townBassSeq.start(0); Tone.Transport.start(); }
async function startChapelMusic() { if (Tone.context.state !== 'running') await Tone.start(); Tone.Transport.bpm.value = 80; initChapelMusic(); chapelMelodySeq.start(0); Tone.Transport.start(); }
async function startVictoryMusic() { if (Tone.context.state !== 'running') await Tone.start(); Tone.Transport.bpm.value = 140; initVictoryMusic(); victoryMelodySeq.start(0); victoryBassSeq.start(0); Tone.Transport.start(); }
function playMusic(track) {
    if (currentSong === track) return;
    stopAllMusic(); currentSong = track;
    if (track === 'BATTLE') startBattleMusic(); else if (track === 'ROAM') startTownMusic(); else if (track === 'CHAPEL') startChapelMusic(); else if (track === 'WIN') startVictoryMusic();
}
function playSound(type) {
    if (isMuted) return;
    if(Tone && Tone.context.state === 'running') {
        const synth = new Tone.Synth().toDestination(); const noise = new Tone.NoiseSynth().toDestination();
        if (type === 'SELECT') synth.triggerAttackRelease("C6", "32n"); if (type === 'CORRECT') synth.triggerAttackRelease("E6", "16n");
        if (type === 'WRONG') { noise.noise.type = 'pink'; noise.triggerAttackRelease("8n"); } if (type === 'HIT') { noise.noise.type = 'white'; noise.triggerAttackRelease("16n"); }
        if (type === 'ALERT') synth.triggerAttackRelease("C7", "32n");
    }
}
const MAP_LAYOUTS = {
    'COMMON_ROOM': {
        name: "COMMON ROOM (HUB)", color: '#333344',
        data: [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,5,0,0,0,0,0,4,3,3,4,0,0,0,0,0,0,0,5,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,4,3,4,0,0,0,0,0,0,0,4,3,4,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,4,3,3,4,0,0,4,3,3,4,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,4,3,4,0,0,0,0,0,0,0,4,3,4,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ],
        npcs: [
            { id: 'mcmahon_intro', name: 'Mrs McMahon', role: 'Teacher', spriteKey: 'mcmahon', color: '#5555ff', gridX: 10, gridY: 3, dialogue: ["Improper use of AI is sweeping Archbishop Ilsley.", "The bugs have locked Mrs Grant in her office.", "You must defeat the bugs in the classrooms to unlock her door.", "Once opened, fight the Main Glitch to save our data!", "Press 'A' or SPACE to interact with staff and items.", "Good Luck."] },
            { id: 'clinton', name: 'Mr Clinton', role: 'Head Teacher', spriteKey: 'clinton', color: '#333333', gridX: 5, gridY: 5, dialogue: ["I am Mr Clinton, the head teacher.", "We have some bugs."] },
            { id: 'oneill_strict_cr', name: 'Mrs O\'Neill', role: 'Head of Behaviour', spriteKey: 'oneill_strict', color: '#ff0000', gridX: 15, gridY: 8, dialogue: [], autoInteract: true, damage: 10, messages: ["You are being too loud!", "I told you to get to lesson!", "This isn't a doss house!"] },
            { id: 'brookes', name: 'Mr Brookes', role: 'Media & Film', spriteKey: 'brookes', color: '#44aa44', gridX: 2, gridY: 5, dialogue: ["*SIGH* I told them we needed more AI and Media Literacy training...", "But would they listen... No!", "Anyways, you might want to avoid Ms O'Neill.", "If you need some health points, visit the canteen or chapel."] }
        ],
        minions: [],
        doors: [{ x: 9, y: 13, target: 'CORRIDOR', targetX: 9, targetY: 2 }, { x: 10, y: 13, target: 'CORRIDOR', targetX: 10, targetY: 2 }, { x: 19, y: 7, target: 'OFFICE', targetX: 1, targetY: 7 }],
        crowd: []
    },
    'CORRIDOR': {
        name: "MAIN CORRIDOR", color: '#222222',
        data: [[1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [
            { id: 'oneill_strict', name: 'Mrs O\'Neill', role: 'Head of Behaviour', spriteKey: 'oneill_strict', color: '#ff0000', gridX: 5, gridY: 6, dialogue: [], autoInteract: true, damage: 10, messages: ["You are being too loud!", "I told you to get to lesson!", "This isn't a doss house!"] },
            { id: 'foley', name: 'Mr Foley', role: 'Teacher', spriteKey: 'clinton', color: '#00aaaa', gridX: 8, gridY: 4, dialogue: ["Come on now, walk with purpose, every minute matters!"] },
            { id: 'regan', name: 'Dr Regan', role: 'DofE Leader', spriteKey: 'botwright', color: '#556b2f', gridX: 16, gridY: 10, dialogue: ["Boots check! Map check! Have you logged into eDofE check?", "For volunteering, you could use AI to help a charity.", "It is great for drafting newsletters or planning fundraising events!"] }
        ],
        minions: [],
        doors: [{ x: 9, y: 0, target: 'COMMON_ROOM', targetX: 9, targetY: 12 }, { x: 10, y: 0, target: 'COMMON_ROOM', targetX: 10, targetY: 12 }, { x: 19, y: 3, target: 'CANTEEN', targetX: 2, targetY: 7 }, { x: 0, y: 5, target: 'CHAPEL', targetX: 18, targetY: 7 }, { x: 0, y: 9, target: 'MAIN_OFFICE', targetX: 18, targetY: 7 }, { x: 9, y: 13, target: 'CLASSROOM_HALL', targetX: 9, targetY: 1 }, { x: 10, y: 13, target: 'CLASSROOM_HALL', targetX: 10, targetY: 1 }],
        crowd: [{ gridX: 4, gridY: 3, spriteKey: 'student', facingRight: true }, { gridX: 16, gridY: 4, spriteKey: 'student', facingRight: false }, { gridX: 8, gridY: 10, spriteKey: 'student', facingRight: true }, { gridX: 14, gridY: 11, spriteKey: 'student', facingRight: false }, { gridX: 2, gridY: 7, spriteKey: 'student', facingRight: true }, { gridX: 18, gridY: 6, spriteKey: 'student', facingRight: false }]
    },
    'MAIN_OFFICE': {
        name: "MAIN OFFICE", color: '#333355',
        data: [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,5,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,5,1],
            [1,0,7,0,0,7,0,0,7,0,0,0,0,3,0,0,0,0,0,1],
            [1,0,4,0,0,4,0,0,4,0,0,0,0,3,0,4,4,4,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,1],
            [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,1],
            [1,0,7,0,0,7,0,0,0,0,0,0,0,3,0,0,0,0,0,1],
            [1,0,4,0,0,4,0,0,0,0,0,0,0,3,0,4,4,4,0,1],
            [1,5,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,5,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ],
        npcs: [
            { id: 'pearson', name: 'Mrs Pearson', role: 'Office Manager', spriteKey: 'pearson', color: '#aa00aa', gridX: 12, gridY: 6, dialogue: ["Can't talk, sorting cover.", "But remember: AI often lacks local knowledge.", "If it sounds generic, check it!"] },
            { id: 'staff1', name: 'Office Staff', role: 'Admin', spriteKey: 'julie', color: '#888888', gridX: 2, gridY: 3, dialogue: ["Busy, busy, busy..."], static: true },
            { id: 'staff2', name: 'Office Staff', role: 'Admin', spriteKey: 'julie', color: '#888888', gridX: 5, gridY: 3, dialogue: ["Did you sign in?"], static: true },
            { id: 'blair', name: 'Mr Blair', role: 'Maths', spriteKey: 'blair', color: '#008080', gridX: 16, gridY: 5, dialogue: ["You should come to Maths Club.", "I am trying to devise a strategy to finally beat Mr Jackson at chess.", "Did you know AI mastered chess years ago? Deep Blue beat Kasparov in 1997!"] }
        ],
        minions: [{gridX: 8, gridY: 9, spriteKey: 'bug', active: true}],
        doors: [{ x: 19, y: 7, target: 'CORRIDOR', targetX: 1, targetY: 9 }, { x: 0, y: 7, target: 'PASTORAL_OFFICE', targetX: 18, targetY: 7 }],
        crowd: []
    },
    'PASTORAL_OFFICE': {
        name: "PASTORAL OFFICE", color: '#2a3b4c',
        data: [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,1],
            [1,0,0,3,3,0,0,3,3,0,0,3,3,0,0,0,0,0,0,1],
            [1,0,0,4,4,0,0,4,4,0,0,4,4,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,4,3,4,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,4,0,4,0,4,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ],
        npcs: [
            { id: 'bruton', name: 'Mr Bruton', role: 'Head of Year', spriteKey: 'grant', color: '#00ffff', gridX: 15, gridY: 5, dialogue: ["Stay reactive but stable, like a Noble Gas!", "If you're feeling under pressure, remember: PV = nRT.", "Balance your revision equation carefully.", "Come to Chemistry Club!"] },
            { id: 'pastoral1', name: 'Pastoral Staff', role: 'Support', spriteKey: 'julie', color: '#ffcc00', gridX: 4, gridY: 3, dialogue: ["Take deep breaths.", "Everything will be okay.", "Revision works best in small chunks."] },
            { id: 'pastoral2', name: 'Pastoral Staff', role: 'Support', spriteKey: 'julie', color: '#ffcc00', gridX: 8, gridY: 3, dialogue: ["Remember to drink water.", "Don't forget to sleep properly!"] },
            { id: 'pastoral3', name: 'Pastoral Staff', role: 'Support', spriteKey: 'julie', color: '#ffcc00', gridX: 12, gridY: 3, dialogue: ["Don't bottle up your stress.", "We are here to listen.", "You can do this!"] }
        ],
        minions: [{gridX: 8, gridY: 8, spriteKey: 'bug', active: true}],
        doors: [{ x: 19, y: 7, target: 'MAIN_OFFICE', targetX: 1, targetY: 7 }],
        crowd: [
            { gridX: 2, gridY: 9, spriteKey: 'student', facingRight: true, static: true }, 
            { gridX: 4, gridY: 9, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 6, gridY: 9, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 10, gridY: 6, spriteKey: 'student', facingRight: false, moveChance: 0.1 }, 
            { gridX: 3, gridY: 11, spriteKey: 'student', facingRight: true, moveChance: 0.1 }
        ]
    },
    'CANTEEN': {
        name: "THE CANTEEN", color: '#302020',
        data: [
            [1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,3,3,3,3,0,0,3,3,3,3,0,0,3,3,3,3,0,0,1],
            [1,4,4,4,4,0,0,4,4,4,4,0,0,4,4,4,4,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,3,3,3,3,0,0,3,3,3,3,0,0,3,3,3,3,0,0,1],
            [1,4,4,4,4,0,0,4,4,4,4,0,0,4,4,4,4,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,6,6,6,6,6,6,6,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1]
        ],
        npcs: [
            { id: 'julie', name: 'Julie', role: 'Canteen Staff', spriteKey: 'julie', color: '#ffffff', gridX: 10, gridY: 6, dialogue: ["Hi love! Need a break?", "Here, have a hot meal. It's on the house."], heal: true },
            { id: 'student_chicken', name: 'Student', role: 'Year 12', spriteKey: 'student', color: '#ddddff', gridX: 8, gridY: 10, dialogue: ["Do the bugs know it is Chicken Burger day?"] },
            { id: 'student_art', name: 'Student', role: 'Year 13', spriteKey: 'student', color: '#ddddff', gridX: 3, gridY: 4, dialogue: ["I am just completing my Art Competition entry."], static: true },
            { id: 'student_hungry', name: 'Student', role: 'Year 12', spriteKey: 'student', color: '#ddddff', gridX: 9, gridY: 4, dialogue: ["I am sooooooo hungry."], static: true },
            { id: 'mcdonald', name: 'Mr McDonald', role: 'Teacher', spriteKey: 'mcdonald', color: '#ffff00', gridX: 5, gridY: 8, dialogue: ["I am on duty. I hope the bugs do not mess with Bromcom today"] }
        ],
        minions: [],
        doors: [{ x: 0, y: 7, target: 'CORRIDOR', targetX: 18, targetY: 3 }, { x: 19, y: 7, target: 'ASTRO_TURF', targetX: 1, targetY: 7 }, { x: 9, y: 0, target: 'DT_BLOCK', targetX: 9, targetY: 13 }, { x: 10, y: 0, target: 'DT_BLOCK', targetX: 10, targetY: 13 }, { x: 9, y: 14, target: 'RS_BLOCK', targetX: 9, targetY: 1 }, { x: 10, y: 14, target: 'RS_BLOCK', targetX: 10, targetY: 1 }],
        crowd: [
            { gridX: 2, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, 
            { gridX: 14, gridY: 4, spriteKey: 'student', facingRight: false, static: true },
            { gridX: 6, gridY: 2, spriteKey: 'student', facingRight: true, moveChance: 0.05 },
            { gridX: 14, gridY: 6, spriteKey: 'student', facingRight: false, moveChance: 0.05 },
            { gridX: 9, gridY: 12, spriteKey: 'student', facingRight: true, moveChance: 0.05 }
        ]
    },
    'DT_BLOCK': {
        name: "DT BLOCK", color: '#3d3d3d',
        data: [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,3,3,3,0,3,3,3,0,3,3,3,0,3,3,3,0,0,1],
            [1,0,3,3,3,0,3,3,3,0,3,3,3,0,3,3,3,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,3,3,3,0,3,3,3,0,3,3,3,0,3,3,3,0,0,1],
            [1,0,3,3,3,0,3,3,3,0,3,3,3,0,3,3,3,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,7,7,7,0,0,0,0,0,0,0,0,7,7,7,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ],
        npcs: [
            { id: 'lakin', name: 'Mr Lakin', role: 'DT Teacher', spriteKey: 'lakin', color: '#8888ff', gridX: 3, gridY: 5, dialogue: ["The laser cutter is finally working!", "Don't forget your PPE.", "AI can help design, but you must build it."] },
            { id: 'meredith', name: 'Mr Meredith', role: 'Careers Lead', spriteKey: 'botwright', color: '#a0522d', gridX: 16, gridY: 5, dialogue: ["Have you sorted your work experience yet?", "AI skills are in high demand for future careers.", "Check your emails for placement opportunities!"] },
            { id: 'francioso', name: 'Mr Francioso', role: 'Head of Year', spriteKey: 'brookes', color: '#800080', gridX: 10, gridY: 8, dialogue: ["Tuck your shirt in!", "Design requires precision.", "If you use AI for your coursework, reference it or it's malpractice."] }
        ],
        minions: [{gridX: 10, gridY: 9, spriteKey: 'bug', active: true}],
        doors: [{ x: 9, y: 13, target: 'CANTEEN', targetX: 9, targetY: 2 }, { x: 10, y: 13, target: 'CANTEEN', targetX: 10, targetY: 2 }],
        crowd: []
    },
    'ASTRO_TURF': {
        name: "ASTRO TURF", color: '#38761d',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [
            { id: 'hemmings', name: 'Mr Hemmings', role: 'Teacher', spriteKey: 'hemmings', color: '#8b4513', gridX: 10, gridY: 13, dialogue: ["It is a bit nippy today", "Don't let AI write your code without understanding it", "Verify every fact.", "AI is a tool, not a replacement.", "Fancy a penalty shootout?", "Get 3 goals for a prize!"] }
        ],
        minions: [],
        doors: [{ x: 0, y: 7, target: 'CANTEEN', targetX: 18, targetY: 7 }],
        crowd: [
            { gridX: 5, gridY: 5, spriteKey: 'student', facingRight: true, moveChance: 0.1 }, 
            { gridX: 15, gridY: 8, spriteKey: 'student', facingRight: false, moveChance: 0.1 },
            { gridX: 5, gridY: 9, spriteKey: 'student', facingRight: true, static: true }, 
            { gridX: 15, gridY: 9, spriteKey: 'student', facingRight: false, static: true }, 
            { 
                gridX: 5, gridY: 9, spriteKey: 'ball', facingRight: true, 
                behavior: 'passing', 
                targets: [{x: 5, y: 9}, {x: 15, y: 9}], 
                currentTarget: 1, 
                pixelX: 5*40, pixelY: 9*40, 
                waitTimer: 0
            }
        ]
    },
    'RS_BLOCK': {
        name: "RS BLOCK", color: '#4b3621',
        data: [
            [1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,6,0,0,6,0,0,0,0,0,0,0,6,0,0,6,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,3,3,3,0,0,3,3,3,0,0,3,3,3,0,0,0,0,1],
            [1,0,4,4,4,0,0,4,4,4,0,0,4,4,4,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,3,3,3,0,0,3,3,3,0,0,3,3,3,0,0,0,0,1],
            [1,0,4,4,4,0,0,4,4,4,0,0,4,4,4,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ],
        npcs: [
            { id: 'duffy', name: 'Miss Duffy', role: 'Head of RS', spriteKey: 'mcmahon', color: '#ffd700', gridX: 15, gridY: 4, dialogue: ["Is AI created in God's image, or ours?", "We must consider the ethics of artificial consciousness.", "Compassion is something an algorithm cannot replicate."] },
            { id: 'patel', name: 'Miss Patel', role: 'Debate Club', spriteKey: 'patel', color: '#ff9900', gridX: 4, gridY: 8, dialogue: ["We are debating AI ethics today.", "Does a chatbot have a soul?", "Come join Debate Club on Thursdays!"] },
            { id: 'botwright', name: 'Mr Botwright', role: 'Tutor', spriteKey: 'botwright', color: '#5555ff', gridX: 12, gridY: 8, dialogue: ["Global Link isn't just geography, it's about understanding people.", "Different cultures view technology in different ways."] }
        ],
        minions: [{gridX: 9, gridY: 7, spriteKey: 'bug', active: true}],
        doors: [{ x: 9, y: 0, target: 'CANTEEN', targetX: 9, targetY: 13 }, { x: 10, y: 0, target: 'CANTEEN', targetX: 10, targetY: 13 }],
        crowd: []
    },
    'CLASSROOM_HALL': {
        name: "LOWER CORRIDOR", color: '#222222',
        // Added door (2) at the bottom center (9, 8)
        data: [[1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[2,0,0,0,0,0,2,0,0,0,0,0,2,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1],[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],
        npcs: [
            { id: 'oneill_strict_ch', name: 'Mrs O\'Neill', role: 'Head of Behaviour', spriteKey: 'oneill_strict', color: '#ff0000', gridX: 3, gridY: 3, dialogue: [], autoInteract: true, damage: 10, messages: ["You are being too loud!", "I told you to get to lesson!", "This isn't a doss house!"] }
        ],
        minions: [],
        // Added door to COMPUTER_SUITE
        doors: [{ x: 9, y: 0, target: 'CORRIDOR', targetX: 9, targetY: 12 }, { x: 10, y: 0, target: 'CORRIDOR', targetX: 10, targetY: 12 }, { x: 0, y: 4, target: 'CLASSROOM_1', targetX: 18, targetY: 7 }, { x: 6, y: 4, target: 'CLASSROOM_2', targetX: 9, targetY: 13 }, { x: 12, y: 4, target: 'CLASSROOM_3', targetX: 9, targetY: 13 }, { x: 9, y: 8, target: 'COMPUTER_SUITE', targetX: 9, targetY: 1 }, { x: 10, y: 8, target: 'COMPUTER_SUITE', targetX: 10, targetY: 1 }],
        crowd: []
    },
    'COMPUTER_SUITE': {
        name: "COMPUTER SUITE", color: '#202030',
        // 7 is the new Computer Tile
        data: [[1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,7,7,7,0,7,7,7,0,7,7,7,0,7,7,7,0,0,1],[1,0,4,4,4,0,4,4,4,0,4,4,4,0,4,4,4,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,7,7,7,0,7,7,7,0,7,7,7,0,7,7,7,0,0,1],[1,0,4,4,4,0,4,4,4,0,4,4,4,0,4,4,4,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,7,7,7,0,7,7,7,0,7,7,7,0,7,7,7,0,0,1],[1,0,4,4,4,0,4,4,4,0,4,4,4,0,4,4,4,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [
            { id: 'rose', name: 'Mrs Rose', role: 'IT Lead', spriteKey: 'rose', color: '#ff69b4', gridX: 2, gridY: 2, dialogue: ["Welcome to the Computer Suite!", "AI can generate code, but it cannot generate logic.", "Always debug AI output. It doesn't 'know' what it is writing!"] }
        ],
        minions: [{gridX: 9, gridY: 6, spriteKey: 'bug', active: true}],
        doors: [{ x: 9, y: 0, target: 'CLASSROOM_HALL', targetX: 9, targetY: 7 }, { x: 10, y: 0, target: 'CLASSROOM_HALL', targetX: 10, targetY: 7 }],
        crowd: [
            // Row 1
            { gridX: 2, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 3, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 4, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 6, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 7, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 8, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 10, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 11, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 12, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 14, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 15, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 16, gridY: 4, spriteKey: 'student', facingRight: true, static: true },
            // Row 2
            { gridX: 2, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 3, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 4, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 6, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 7, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 8, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 10, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 11, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 12, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 14, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 15, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 16, gridY: 8, spriteKey: 'student', facingRight: true, static: true },
            // Row 3
            { gridX: 2, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 3, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 4, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 6, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 7, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 8, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 10, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 11, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 12, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 14, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 15, gridY: 12, spriteKey: 'student', facingRight: true, static: true },
            { gridX: 16, gridY: 12, spriteKey: 'student', facingRight: true, static: true }
        ]
    },
    'CLASSROOM_1': {
        name: "CLASSROOM 1", color: '#252525',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [{ id: 'jones', name: 'Mr Jones', role: 'History', spriteKey: 'jones', color: '#aaffaa', gridX: 15, gridY: 2, dialogue: ["The Berlin and Belgium trip is simply the best experience!", "Use AI for research, but verify everything.", "We cannot have hallucinations when discussing World War 2."] }],
        minions: [{gridX:5,gridY:5,spriteKey:'bug',active:true}], doors: [{x:19,y:7,target:'CLASSROOM_HALL',targetX:1,targetY:4}],
        crowd: [{ gridX: 2, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 5, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 8, gridY: 10, spriteKey: 'student', facingRight: true, static: true }]
    },
    'CLASSROOM_2': {
        name: "CLASSROOM 2", color: '#252525',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [{ id: 'russell', name: 'Miss Russell', role: 'Science', spriteKey: 'russell', color: '#aaaaff', gridX: 2, gridY: 2, dialogue: ["Biology unlocks the secrets of life—it is truly the best subject!", "Ensure you verify all your data; AI cannot replace real experiments.", "On another note, Wicked is absolutely amazing. You must go see it!"] }],
        minions: [{gridX:10,gridY:8,spriteKey:'bug',active:true}], doors: [{x:9,y:13,target:'CLASSROOM_HALL',targetX:6,targetY:5}],
        crowd: [{ gridX: 4, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 10, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 2, gridY: 10, spriteKey: 'student', facingRight: true, static: true }]
    },
    'CLASSROOM_3': {
        name: "CLASSROOM 3", color: '#252525',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,3,3,0,3,3,0,3,3,0,3,3,0,0,0,0,0,0,0,1],[1,4,4,0,4,4,0,4,4,0,4,4,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [
            { id: 'mckeown', name: 'Mrs McKeown', role: 'English', spriteKey: 'mckeown', color: '#ffaaaa', gridX: 15, gridY: 2, dialogue: ["We are studying 'An Inspector Calls' today.", "Mr Birling would love AI...", "...because he could just sack people more easily!", "Make sure your work has your own human voice."] },
            { id: 'herron', name: 'Mrs Herron', role: 'English', spriteKey: 'herron', color: '#ffff00', gridX: 2, gridY: 2, dialogue: ["'I think of thee!' - Sonnet 29 by Elizabeth Barrett Browning.", "It is part of the Love and Relationships Cluster.", "AI cannot replicate the passion of 'wild vines' around a tree!"] }
        ],
        minions: [{gridX:14,gridY:5,spriteKey:'bug',active:true}], doors: [{x:9,y:13,target:'CLASSROOM_HALL',targetX:12,targetY:5}],
        crowd: [{ gridX: 1, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 7, gridY: 4, spriteKey: 'student', facingRight: true, static: true }, { gridX: 5, gridY: 10, spriteKey: 'student', facingRight: true, static: true }]
    },
    'OFFICE': {
        name: "MRS GRANT'S OFFICE", color: '#301010',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,5,0,3,0,3,0,3,0,0,0,3,0,3,0,3,0,5,1],[1,0,0,4,0,4,0,4,0,0,0,4,0,4,0,4,0,0,1],[1,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,4,0,4,0,4,0,0,0,4,0,4,0,4,0,0,1],[1,5,0,3,0,3,0,3,0,0,0,3,0,3,0,3,0,5,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [{ id: 'grant_final', name: 'Mrs Grant', role: 'Head of Sixth Form', spriteKey: 'grant', color: '#ff5555', gridX: 16, gridY: 7, dialogue: ["The Main Glitch is right there!", "Defeat it to recover the JCQ Guidance data!"] }],
        minions: [],
        doors: [{ x: 0, y: 7, target: 'COMMON_ROOM', targetX: 18, targetY: 7 }],
        boss: { active: true, gridX: 9, gridY: 5, spriteKey: 'glitch', hp: 100 },
        crowd: []
    },
    'CHAPEL': {
        name: "THE CHAPEL", color: '#202040',
        data: [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,4,4,4,4,0,0,0,0,0,4,4,4,4,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],
        npcs: [
            { id: 'deacon', name: 'Deacon Martin', role: 'Chaplain', spriteKey: 'deacon', color: '#aaaaaa', gridX: 9, gridY: 2, dialogue: ["Peace be with you.", "Let me heal your weary soul."], heal: true },
            { id: 'student_praying_1', name: 'Student', role: 'Year 13', spriteKey: 'student_kneeling', color: '#ddddff', gridX: 12, gridY: 4, dialogue: ["Please let the bugs go away...", "Amen."], static: true },
            { id: 'student_praying_2', name: 'Student', role: 'Year 12', spriteKey: 'student_kneeling', color: '#ddddff', gridX: 6, gridY: 4, dialogue: ["I hope I pass my mocks...", "Please guide me."], static: true },
            { id: 'student_praying_3', name: 'Student', role: 'Year 13', spriteKey: 'student_kneeling', color: '#ddddff', gridX: 8, gridY: 10, dialogue: ["Quiet please, I am reflecting."], static: true }
        ],
        minions: [],
        doors: [{ x: 19, y: 7, target: 'CORRIDOR', targetX: 1, targetY: 5 }],
        crowd: []
    }
};
const STATE = { INTRO: 0, ROAM: 1, DIALOGUE: 2, BATTLE: 3, GAMEOVER: 4, WIN: 5, TRANSITION: 6, PENALTY: 7 };
let currentState = STATE.INTRO;
let frames = 0;
let winTimer = 0; 
let transitionTimer = 0; 
let faintTimer = 0; 
let introCutsceneActive = false;
let introCutsceneFinished = false;
let officeCutsceneActive = false; 
let officeCutscenePlayed = false; 

const player = { 
    gridX: 10, gridY: 7, x: 400, y: 280, targetX: 400, targetY: 280, isMoving: false, facingRight: true, bobFrame: 0,
    hp: 100, maxHp: 100, auth: 100, maxAuth: 100, spriteKey: 'player', inventory: [], interactionCooldown: 0, autoInteractCooldown: 0, currentRoom: 'COMMON_ROOM'
};
let activeRoom = MAP_LAYOUTS['COMMON_ROOM'];
let activeMap = activeRoom.data;
let activeNPCs = activeRoom.npcs;
let activeMinions = activeRoom.minions;
let activeCrowd = activeRoom.crowd || [];
let activeBoss = null;

activeNPCs.forEach(n => { n.pixelX = n.gridX * TILE_SIZE; n.pixelY = n.gridY * TILE_SIZE; n.targetPixelX = n.pixelX; n.targetPixelY = n.pixelY; n.isMoving = false; });

let battleState = 'MENU';
let battleTurn = 'PLAYER';
let activeBattleEnemy = {};
let battleMenuIdx = 0;
let battleMsg = "";
let battleEffects = [];
let battleShake = 0;
let matrixRain = [];
let currentQuestion = null;
let selectedOptionIdx = 0;
let pendingAction = ''; 
let battleTargetIndex = -1; // Added to track which minion
let pendingDamage = 0;

// Penalty Shootout Global Vars
let penaltyActive = false;
let penaltyScore = 0;
let penaltyShots = 0;
let penaltyTargetX = 400;
let penaltyTargetSpeed = 8;
let penaltyGoalkeeperX = 400;
let penaltyBallX = 400;
let penaltyBallY = 500;
let penaltyState = 'AIM'; // AIM, SHOOT, RESULT
let penaltyMsg = "";

const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, " ": false };
let keyProcessed = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, " ": false };

window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key) || e.key === " ") { keys[e.key] = true; } });
window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key) || e.key === " ") { keys[e.key] = false; keyProcessed[e.key] = false; } });

// --- DIALOGUE FUNCTIONS ---
let dialogueQueue = []; let dialogueSpeaker = "";
function startDialogue(npc) {
    if (player.interactionCooldown > 0) return;
    playSound('SELECT');
    dialogueQueue = [...npc.dialogue];
    if (npc.heal) dialogueQueue.push("[HP RESTORED]");
    
    dialogueSpeaker = npc.name;
    currentState = STATE.DIALOGUE;
    document.getElementById('dialogue-box').style.display = 'block';
    document.getElementById('dialogue-name').innerText = dialogueSpeaker;
    document.getElementById('dialogue-text').innerText = dialogueQueue[0];
    // Change dialogue text color if Mrs Pearson
    if (npc.id === 'pearson') {
        document.getElementById('dialogue-name').style.color = npc.color; 
    } else {
        document.getElementById('dialogue-name').style.color = '#d00';
    }

    player.interactionCooldown = 15;
}
function advanceDialogue() {
    dialogueQueue.shift();
    if (dialogueQueue.length === 0) { 
        currentState = STATE.ROAM; 
        document.getElementById('dialogue-box').style.display = 'none'; 
        player.interactionCooldown = 20; 
        // Check for Hemmings game trigger
        if (dialogueSpeaker === "Mr Hemmings") {
             initPenalty();
        }
    }
    else { document.getElementById('dialogue-text').innerText = dialogueQueue[0]; player.interactionCooldown = 15; }
}

// --- PENALTY SHOOTOUT VARIABLES & FUNCTIONS ---
function initPenalty() {
    currentState = STATE.PENALTY;
    penaltyScore = 0;
    penaltyShots = 0;
    penaltyState = 'AIM';
    penaltyMsg = "Take 5 shots! Goal: 3";
    penaltyTargetX = 400;
    penaltyTargetSpeed = 4; // Reduced from 8 to 4 (Slower Aim)
    penaltyGoalkeeperX = 400;
    penaltyBallX = 400;
    penaltyBallY = 500;
}

function updatePenalty() {
    if (penaltyState === 'AIM') {
        penaltyTargetX += penaltyTargetSpeed;
        if (penaltyTargetX > 600 || penaltyTargetX < 200) penaltyTargetSpeed *= -1;
        // Slower Goalie movement (0.03 instead of 0.05)
        penaltyGoalkeeperX = 400 + Math.sin(frames * 0.03) * 120; 

        if (keys[" "] && !keyProcessed[" "]) {
            keyProcessed[" "] = true;
            penaltyState = 'SHOOT';
            playSound('HIT');
        }
    } else if (penaltyState === 'SHOOT') {
        penaltyBallY -= 8; // Slower shot speed (was 15)
        const dx = (penaltyTargetX - 400) * 0.05; // Adjusted angle calculation
        penaltyBallX += dx;

        if (penaltyBallY < 150) { // Reached goal line (150 is deeper in net)
            // Improved Collision: 
            // Goalie width is 80px, so center +/- 40px is a hit. 
            // Added slightly tighter hitbox (50) to feel fairer.
            if (Math.abs(penaltyBallX - penaltyGoalkeeperX) < 50) {
                penaltyState = 'RESULT';
                penaltyMsg = "SAVED by the Bug!";
                playSound('WRONG');
            } else if (penaltyBallX > 190 && penaltyBallX < 610) { // Hitting posts or inside
                penaltyState = 'RESULT';
                penaltyScore++;
                penaltyMsg = "GOAL!";
                playSound('CORRECT');
            } else {
                penaltyState = 'RESULT';
                penaltyMsg = "MISS!";
                playSound('WRONG');
            }
            penaltyShots++;
        }
    } else if (penaltyState === 'RESULT') {
        if (keys[" "] && !keyProcessed[" "]) {
            keyProcessed[" "] = true;
            if (penaltyShots < 5) {
                penaltyState = 'AIM';
                penaltyBallX = 400;
                penaltyBallY = 500;
                penaltyMsg = `Score: ${penaltyScore}/${penaltyShots}`;
            } else {
                // End Game
                currentState = STATE.ROAM;
                // CRITICAL FIX: Reset cooldown so dialogue can actually start
                player.interactionCooldown = 0; 
                
                if (penaltyScore >= 3) {
                    player.hp = player.maxHp;
                    // Name changed to 'Coach Hemmings' to prevent infinite game loop in advanceDialogue
                    startDialogue({ name: 'Coach Hemmings', role: 'Coach', dialogue: ["Well done!", `You scored ${penaltyScore}/5!`, "Here is your prize: A Stamina Boost!", "Your HP is fully restored!"], heal: true });
                } else {
                    startDialogue({ name: 'Coach Hemmings', role: 'Coach', dialogue: ["Unlucky!!!", `Only ${penaltyScore}/5 goals.`, "Keep practicing!"] });
                }
            }
        }
    }
}

function drawPenalty() {
    // Draw Pitch
    ctx.fillStyle = '#38761d';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw Goal
    ctx.fillStyle = '#fff';
    ctx.fillRect(190, 100, 420, 10); // Top bar
    ctx.fillRect(190, 100, 10, 100); // Left post
    ctx.fillRect(600, 100, 10, 100); // Right post
    
    // Draw Net
    ctx.strokeStyle = "rgba(255,255,255,0.5)";
    ctx.beginPath();
    for(let i=200; i<=600; i+=20) { ctx.moveTo(i, 100); ctx.lineTo(i, 200); }
    ctx.stroke();

    // Draw Goalie
    drawSprite(ctx, 'bug', penaltyGoalkeeperX - 40, 150, 80, true);

    // Draw Player
    if (penaltyState === 'AIM') {
        drawSprite(ctx, 'player', 360, 500, 80, false);
    }

    // Draw Ball
    drawSprite(ctx, 'ball', penaltyBallX - 20, penaltyBallY - 20, 40, true);

    // Draw Target Reticle
    if (penaltyState === 'AIM') {
        ctx.strokeStyle = '#ff0000';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(penaltyTargetX, 180, 20, 0, Math.PI*2);
        ctx.stroke();
        ctx.moveTo(penaltyTargetX - 25, 180); ctx.lineTo(penaltyTargetX + 25, 180);
        ctx.moveTo(penaltyTargetX, 155); ctx.lineTo(penaltyTargetX, 205);
        ctx.stroke();
    }

    // UI
    ctx.fillStyle = '#000';
    ctx.font = '20px "Press Start 2P"';
    ctx.fillText(penaltyMsg, 400, 50);
    ctx.font = '14px "Press Start 2P"';
    ctx.fillText(`Shots: ${penaltyShots}/5  Score: ${penaltyScore}`, 400, 80);
    
    if (penaltyState === 'RESULT') {
        ctx.fillStyle = '#fff';
        ctx.fillText("Press [A] to Continue", 400, 550);
    }
}

// --- MATRIX RAIN ---
function initMatrixRain() {
    matrixRain = [];
    for(let i=0; i<50; i++) {
        matrixRain.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, speed: Math.random() * 5 + 2, chars: "101010 AI ERROR JCQ" });
    }
}
initMatrixRain();

// --- QUESTIONS DATABASE ---
const QUESTIONS = [
    { q: "According to JCQ, what must a school’s malpractice policy include?", options: ["Instructions for improving AI writing quality", "Rules for AI use in assessments", "A list of AI tools teachers recommend"], answer: 1 },
    { q: "What are teachers responsible for confirming?", options: ["That AI tools have been used efficiently", "That students enjoyed the task", "The authenticity of each student’s work"], answer: 2 },
    { q: "What must students do if they use AI in permitted coursework?", options: ["Paraphrase the AI output", "Reference the AI tool clearly", "Email the awarding body"], answer: 1 },
    { q: "When can students earn marks for content produced solely by AI?", options: ["Only if they reference it correctly", "Only if the teacher supervises the AI use", "Never—AI-generated content cannot earn marks"], answer: 2 },
    { q: "What is AI misuse according to the JCQ guidance?", options: ["Using AI to check your spelling", "Using AI to generate ideas only", "Taking AI-produced work as your own"], answer: 2 },
    { q: "What should teachers compare work against if they suspect AI misuse?", options: ["The student’s favourite writing style", "Previous work for differences in tone/quality", "The student’s mock exam results only"], answer: 1 },
    { q: "What should students do before signing the declaration on coursework?", options: ["Remove all references to AI", "Double-check all AI usage has been referenced", "Submit anonymously"], answer: 1 },
    { q: "If a student misuses AI, what is a possible consequence?", options: ["A warning with no grade impact", "Extra time on their next assessment", "They may lose marks or be disqualified"], answer: 2 },
    { q: "What is one indicator of AI-generated text?", options: ["Clear references", "Lack of local knowledge/wrong statements", "Use of British spelling"], answer: 1 },
    { q: "If AI misuse is found after a declaration form is signed, what happens?", options: ["Ask the student to redo the work", "Report it to the awarding body", "Remove the mark and move on"], answer: 1 },
    { q: "What is the safest way to interact with AI tools?", options: ["Share personal data to get better answers", "Avoid sharing sensitive information", "Use AI only on public computers"], answer: 1 },
    { q: "Why is it important to check AI outputs?", options: ["AI always provides verified facts", "AI often guesses/generates inaccurate content", "AI can only give answers written by experts"], answer: 1 },
    { q: "Which example demonstrates ethical AI use?", options: ["Using AI to impersonate someone online", "Using AI to support ideas but citing it", "Submitting AI-written work as your own"], answer: 1 },
    { q: "What is a responsible approach when using AI for decision-making?", options: ["Rely entirely on AI recommendations", "Treat AI suggestions critically and verify", "Ignore human judgment in favour of AI"], answer: 1 },
    { q: "Why must AI-generated content be acknowledged in academic work?", options: ["To hide how much AI was used", "Because it helps boost the grade", "Transparency prevents plagiarism"], answer: 2 }
];

// --- MISSING BATTLE FUNCTIONS IMPLEMENTED HERE ---

function startBattle(type, index) {
    playEncounterSfx();
    battleTargetIndex = index;
    
    // Set Enemy Data
    if (type === 'boss') {
        activeBattleEnemy = { name: "MAIN GLITCH", hp: 100, maxHp: 100, lvl: 99, spriteKey: 'glitch', damage: 25 };
    } else {
        activeBattleEnemy = { name: "BUG", hp: 50, maxHp: 50, lvl: 5, spriteKey: 'bug', damage: 10 };
    }

    // Reset Battle State
    battleState = 'MENU';
    battleTurn = 'PLAYER';
    battleMenuIdx = 0;
    battleMsg = "A wild glitch appeared!";
    battleEffects = [];
    faintTimer = 0; 
    
    // Transition Effect
    currentState = STATE.TRANSITION;
    transitionTimer = 90; // 1.5 seconds transition
}

function spawnProjectile(x1, y1, x2, y2, color) {
    battleEffects.push({
        type: 'projectile', x: x1, y: y1, targetX: x2, targetY: y2, 
        speed: 15, color: color, active: true
    });
}

function updateBattle() {
    if (battleShake > 0) battleShake--;

    // Handle Projectiles
    for (let i = battleEffects.length - 1; i >= 0; i--) {
        let p = battleEffects[i];
        if (p.type === 'projectile' && p.active) {
            const dx = p.targetX - p.x;
            const dy = p.targetY - p.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < p.speed) {
                p.x = p.targetX;
                p.y = p.targetY;
                p.active = false; // Hit!
                battleEffects.splice(i, 1);
                // Trigger Impact Logic based on who was shooting
                if (battleState === 'PLAYER_ANIM') {
                    activeBattleEnemy.hp -= pendingDamage;
                    playSound('HIT');
                    battleShake = 5;
                    if (activeBattleEnemy.hp <= 0) {
                        battleState = 'FAINT_ANIM';
                        faintTimer = 0;
                        stopAllMusic();
                        playEnemyDownSfx();
                        battleMsg = "";
                    } else {
                        battleState = 'ENEMY_TURN_START';
                    }
                } else if (battleState === 'ENEMY_ANIM') {
                    player.hp -= activeBattleEnemy.damage;
                    playSound('HIT');
                    battleShake = 10;
                    battleMsg = `${activeBattleEnemy.name} hits you! -${activeBattleEnemy.damage} HP`;
                    battleState = 'RESULT'; // Go to result screen to show damage
                }
            } else {
                p.x += (dx / dist) * p.speed;
                p.y += (dy / dist) * p.speed;
            }
        }
    }

    if (battleState === 'MENU') {
        if (keys.ArrowUp && !keyProcessed.ArrowUp) { battleMenuIdx = (battleMenuIdx - 1 + 3) % 3; keyProcessed.ArrowUp = true; playSound('SELECT'); }
        if (keys.ArrowDown && !keyProcessed.ArrowDown) { battleMenuIdx = (battleMenuIdx + 1) % 3; keyProcessed.ArrowDown = true; playSound('SELECT'); }
        
        if (keys[" "] && !keyProcessed[" "]) {
            keyProcessed[" "] = true;
            if (battleMenuIdx === 0) { // QUESTION
                currentQuestion = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
                selectedOptionIdx = 0;
                battleState = 'QUESTION';
            } else if (battleMenuIdx === 1) { // GEN-AI (Risk Attack)
                 const hit = Math.random() > 0.4; // 60% chance to hit
                 if (hit) {
                     pendingDamage = 35;
                     battleMsg = `Gen-AI Generated Code! -${pendingDamage}`;
                     spawnProjectile(140, 370, 520, 120, '#00ffff'); // Player shoots
                     battleState = 'PLAYER_ANIM';
                 } else {
                     const selfDmg = 15;
                     player.hp -= selfDmg;
                     battleMsg = `Gen-AI Hallucinated! You cited fake laws! -${selfDmg} HP`;
                     playSound('WRONG');
                     battleState = 'RESULT';
                 }
            } else if (battleMenuIdx === 2) { // RUN
                if (activeBattleEnemy.spriteKey === 'glitch') {
                    battleMsg = "You cannot run from the Main Glitch!";
                    battleState = 'RESULT';
                } else {
                    currentState = STATE.ROAM;
                    playMusic('ROAM');
                }
            }
        }
    } else if (battleState === 'QUESTION') {
        if (keys.ArrowUp && !keyProcessed.ArrowUp) { selectedOptionIdx = (selectedOptionIdx - 1 + 3) % 3; keyProcessed.ArrowUp = true; playSound('SELECT'); }
        if (keys.ArrowDown && !keyProcessed.ArrowDown) { selectedOptionIdx = (selectedOptionIdx + 1) % 3; keyProcessed.ArrowDown = true; playSound('SELECT'); }
        
        if (keys[" "] && !keyProcessed[" "]) {
            keyProcessed[" "] = true;
            if (selectedOptionIdx === currentQuestion.answer) {
                pendingDamage = 25;
                battleMsg = `Correct! Integrity Beam! -${pendingDamage}`;
                playSound('CORRECT');
                spawnProjectile(140, 370, 520, 120, '#44ff44'); // Green beam
                battleState = 'PLAYER_ANIM';
            } else {
                battleMsg = "Wrong! The bug attacks you!";
                playSound('WRONG');
                battleState = 'ENEMY_TURN_START';
            }
        }
    } else if (battleState === 'ENEMY_TURN_START') {
        // Small delay before enemy shoots
        setTimeout(() => {
             spawnProjectile(520, 120, 140, 370, '#ff0000'); // Red glitch
             battleState = 'ENEMY_ANIM';
        }, 500);
        battleState = 'WAITING'; // Just wait for timeout
    } else if (battleState === 'RESULT') {
        if (keys[" "] && !keyProcessed[" "]) {
            keyProcessed[" "] = true;
            if (player.hp <= 0) {
                loseGame("Your academic integrity hit 0.");
            } else {
                battleState = 'MENU';
            }
        }
    } else if (battleState === 'FAINT_ANIM') {
        faintTimer++;
        if (faintTimer === 60) { // 1 second mark
            playVictoryFanfare(); // 3. Fanfare
        }
        if (faintTimer === 180) { // 3 seconds mark
            battleState = 'VICTORY_WAIT';
            battleMsg = "Enemy Defeated! Integrity Restored.";
            playMusic('WIN'); // 4. Win Music Loop
        }
    } else if (battleState === 'VICTORY_WAIT') {
        if (keys[" "] && !keyProcessed[" "]) {
            keyProcessed[" "] = true;
            if (activeBattleEnemy.spriteKey === 'glitch') {
                currentState = STATE.WIN;
                // Keep music playing
            } else {
                // Remove Minion
                if (battleTargetIndex > -1) {
                    activeMinions[battleTargetIndex].active = false;
                }
                currentState = STATE.ROAM;
                playMusic('ROAM');
            }
        }
    }
}

function loseGame(reason) {
    currentState = STATE.GAMEOVER;
    battleMsg = reason;
    stopAllMusic();
}

// --- INPUT AND ROOM LOGIC ---
function setupMobileControls() {
    const btnUp = document.getElementById('btn-up');
    const btnDown = document.getElementById('btn-down');
    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    const btnAction = document.getElementById('btn-action');
    const handleTouch = (key, pressed) => { if (pressed) { keys[key] = true; } else { keys[key] = false; keyProcessed[key] = false; } };
    const addBtnListener = (btn, key) => {
        if(!btn) return;
        const start = (e) => { e.preventDefault(); handleTouch(key, true); btn.classList.add('active'); };
        const end = (e) => { e.preventDefault(); handleTouch(key, false); btn.classList.remove('active'); };
        btn.addEventListener('touchstart', start, {passive: false}); btn.addEventListener('touchend', end, {passive: false});
        btn.addEventListener('mousedown', start); btn.addEventListener('mouseup', end); btn.addEventListener('mouseleave', end);
    };
    addBtnListener(btnUp, 'ArrowUp'); addBtnListener(btnDown, 'ArrowDown'); addBtnListener(btnLeft, 'ArrowLeft'); addBtnListener(btnRight, 'ArrowRight'); addBtnListener(btnAction, ' ');
    const overlay = document.getElementById('focus-overlay');
    if(overlay) {
        const startAudio = (e) => { e.preventDefault(); initAudio(); overlay.style.display='none'; document.getElementById('game-container').focus(); };
        overlay.addEventListener('touchstart', startAudio, {passive: false}); overlay.addEventListener('click', startAudio);
    }
}
setupMobileControls();

function switchRoom(roomKey, startX, startY) {
    if (!MAP_LAYOUTS[roomKey]) { console.error("INVALID ROOM KEY:", roomKey); return false; }
    const previousRoom = player.currentRoom;
    if (roomKey === 'OFFICE') {
        // Updated unlock conditions: Pastoral Office, DT Block, Classroom 3
        const pastoralCleared = MAP_LAYOUTS['PASTORAL_OFFICE'].minions.every(m => !m.active);
        const dtCleared = MAP_LAYOUTS['DT_BLOCK'].minions.every(m => !m.active);
        const c3Cleared = MAP_LAYOUTS['CLASSROOM_3'].minions.every(m => !m.active);
        
        if (!pastoralCleared || !dtCleared || !c3Cleared) {
            playSound('ALERT');
            // Updated Status Display to match A/B/C
            const status = `Key A: ${pastoralCleared ? '✓' : ' ✗ '} | Key B: ${dtCleared ? '✓' : ' ✗ '} | Key C: ${c3Cleared ? '✓' : ' ✗ '}`;
            startDialogue({ name: 'THE GLITCH', role: 'SYSTEM LOCK', color: '#ff0000', dialogue: ["HAHAHA! I have locked this door!", "You cannot enter until my minions are defeated.", "Find the correct bugs to destroy to unlock it!", status], heal: false });
            return false; 
        }
        if (!officeCutscenePlayed) { officeCutsceneActive = true; }
    }
    player.currentRoom = roomKey; activeRoom = MAP_LAYOUTS[roomKey]; activeMap = activeRoom.data; activeNPCs = activeRoom.npcs; activeMinions = activeRoom.minions; activeCrowd = activeRoom.crowd || []; activeBoss = activeRoom.boss || null;
    
    const initEntity = (e) => { e.pixelX = e.gridX * TILE_SIZE; e.pixelY = e.gridY * TILE_SIZE; e.targetPixelX = e.pixelX; e.targetPixelY = e.pixelY; e.isMoving = false; };
    activeCrowd.forEach(initEntity); activeNPCs.forEach(initEntity);
    
    player.gridX = startX; player.gridY = startY; player.x = startX * TILE_SIZE; player.y = startY * TILE_SIZE; player.targetX = player.x; player.targetY = player.y;
    document.getElementById('room-name').innerText = activeRoom.name; document.getElementById('room-name').style.display = 'block'; setTimeout(() => document.getElementById('room-name').style.display = 'none', 2000);
    if (roomKey === 'CHAPEL') playMusic('CHAPEL'); else if (previousRoom === 'CHAPEL') playMusic('ROAM');
    return true;
}
function tryMove(dx, dy) {
    if (player.isMoving) return;
    const nextX = player.gridX + dx; const nextY = player.gridY + dy;
    if (nextX < 0 || nextX >= COLS || nextY < 0 || nextY >= ROWS) return;
    const tile = activeMap[nextY][nextX];
    if (tile === 1 || (tile >= 3 && tile <= 7)) return; 
    for(let i=0; i<activeMinions.length; i++) { let m = activeMinions[i]; if (m.active && m.gridX === nextX && m.gridY === nextY) { startBattle('minion', i); return; } }
    if (activeBoss && activeBoss.active && activeBoss.gridX === nextX && activeBoss.gridY === nextY) { startBattle('boss', -1); return; }
    for (let door of activeRoom.doors) { if (door.x === nextX && door.y === nextY) { if(!switchRoom(door.target, door.targetX, door.targetY)) {} return; } }
    for(let npc of activeNPCs) { if (npc.gridX === nextX && npc.gridY === nextY) return; }
    player.gridX = nextX; player.gridY = nextY; player.targetX = nextX * TILE_SIZE; player.targetY = nextY * TILE_SIZE; player.isMoving = true; player.bobFrame = 0;
    if (dx > 0) player.facingRight = true; if (dx < 0) player.facingRight = false;
}
function update() {
    frames++;
    if (currentState === STATE.INTRO) {
        if (keys[" "] && !keyProcessed[" "] && frames > 60) { keyProcessed[" "] = true; currentState = STATE.ROAM; player.interactionCooldown = 20; document.getElementById('intro-screen').style.display = 'none'; if (!introCutsceneFinished) introCutsceneActive = true; }
        return;
    }
    if (currentState === STATE.TRANSITION) { transitionTimer--; if (transitionTimer <= 0) { currentState = STATE.BATTLE; setTimeout(() => { playMusic('BATTLE'); }, 100); } return; }
    if (currentState === STATE.WIN) { winTimer++; }
    if (currentState === STATE.ROAM) {
        if (player.interactionCooldown > 0) player.interactionCooldown--;
        if (player.autoInteractCooldown > 0) player.autoInteractCooldown--;
        
        const handleEntityMove = (p, isNpc) => {
            if (p.static) return;
            if (p.behavior === 'passing') {
                // Custom Passing Logic
                if (!p.waitTimer) p.waitTimer = 0;
                if (p.waitTimer > 0) {
                    p.waitTimer--;
                    return;
                }
                const target = p.targets[p.currentTarget];
                const tx = target.x * TILE_SIZE;
                const ty = target.y * TILE_SIZE;
                const dx = tx - p.pixelX;
                const dy = ty - p.pixelY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const speed = 3; // SLOWED DOWN BALL (Was 6)
                
                if (dist < speed) {
                    p.pixelX = tx;
                    p.pixelY = ty;
                    p.waitTimer = 60; // Wait 1 second at feet
                    p.currentTarget = (p.currentTarget + 1) % p.targets.length;
                } else {
                    p.pixelX += (dx / dist) * speed;
                    p.pixelY += (dy / dist) * speed;
                }
                return;
            }

            if (p.isMoving) {
                const speed = 1; // SLOWED DOWN NPCS (Was 2)
                const dx = p.targetPixelX - p.pixelX; 
                const dy = p.targetPixelY - p.pixelY;
                if (Math.abs(dx) <= speed && Math.abs(dy) <= speed) { p.pixelX = p.targetPixelX; p.pixelY = p.targetPixelY; p.isMoving = false; } else { p.pixelX += Math.sign(dx) * speed; p.pixelY += Math.sign(dy) * speed; }
            } else {
                // Standard movement chance is 0.02 or use entity specific moveChance
                const chance = p.moveChance || ((isNpc && p.spriteKey === 'oneill_strict') ? 0.03 : 0.02);
                if (Math.random() < chance) { 
                    const dir = Math.floor(Math.random() * 4); let dx = 0, dy = 0; if (dir===0) dy=-1; else if(dir===1) dy=1; else if(dir===2) dx=-1; else dx=1;
                    const nx = p.gridX + dx; const ny = p.gridY + dy;
                    if (nx >= 0 && nx < COLS && ny >= 0 && ny < ROWS) {
                        const t = activeMap[ny][nx];
                        if (t === 0 && !(nx===player.gridX && ny===player.gridY)) {
                              let hitNPC = activeNPCs.some(n => n.gridX === nx && n.gridY === ny);
                              let hitCrowd = activeCrowd.some(c => c !== p && c.gridX === nx && c.gridY === ny);
                              if (!hitNPC && !hitCrowd) { p.gridX = nx; p.gridY = ny; p.targetPixelX = nx * TILE_SIZE; p.targetPixelY = ny * TILE_SIZE; p.isMoving = true; p.facingRight = dx > 0; }
                        }
                    }
                }
            }
        };
        activeCrowd.forEach(p => handleEntityMove(p, false));
        activeNPCs.forEach(n => { 
            if (n.isMoving || n.spriteKey === 'oneill_strict') handleEntityMove(n, true); 
        });

        if (introCutsceneActive) {
            if (!player.isMoving) { if (player.gridY > 4) { tryMove(0, -1); } else { introCutsceneActive = false; introCutsceneFinished = true; player.facingRight = true; const npc = activeNPCs.find(n => n.id === 'mcmahon_intro'); if(npc) { player.interactionCooldown = 0; startDialogue(npc); } } }
        } else if (officeCutsceneActive) {
            const grant = activeNPCs.find(n => n.id === 'grant_final');
            if (grant) {
                const dist = Math.abs(grant.gridX - player.gridX);
                if (dist > 2) { if (!grant.isMoving) { grant.gridX -= 1; grant.targetPixelX = grant.gridX * TILE_SIZE; grant.isMoving = true; grant.facingRight = false; } } 
                else if (!grant.isMoving) { officeCutsceneActive = false; officeCutscenePlayed = true; player.interactionCooldown = 0; startDialogue({ name: grant.name, role: grant.role, color: grant.color, dialogue: ["Thank you for unlocking the door.", "The bugs have been terrible.", "I know you will know the answers to defeat the glitch.", "I believe in you!"] }); }
            } else { officeCutsceneActive = false; }
        } else if (player.autoInteractCooldown === 0 && !player.isMoving) {
            const adj = [{x: player.gridX, y: player.gridY - 1}, {x: player.gridX, y: player.gridY + 1}, {x: player.gridX - 1, y: player.gridY}, {x: player.gridX + 1, y: player.gridY}, {x: player.gridX, y: player.gridY}];
            for (let pos of adj) { for (let npc of activeNPCs) { if (npc.autoInteract && npc.gridX === pos.x && npc.gridY === pos.y) { const msg = npc.messages[Math.floor(Math.random() * npc.messages.length)]; player.hp -= npc.damage; playSound('ALERT'); if (player.hp <= 0) { loseGame("Caught by Mrs O'Neill!"); return; } startDialogue({ name: npc.name, role: npc.role, color: npc.color, dialogue: [msg, `[-${npc.damage} HP]`] }); player.autoInteractCooldown = 180; break; } } }
        }
        if (player.isMoving) {
            const speed = 2; // SLOWED DOWN PLAYER (Was 4)
            const dx = player.targetX - player.x; 
            const dy = player.targetY - player.y;
            if (Math.abs(dx) <= speed && Math.abs(dy) <= speed) { player.x = player.targetX; player.y = player.targetY; player.isMoving = false; } else { player.x += Math.sign(dx) * speed; player.y += Math.sign(dy) * speed; player.bobFrame += 0.1; } // Slower bob
        } else if (!introCutsceneActive && !officeCutsceneActive) {
            if (keys.ArrowUp) tryMove(0, -1); else if (keys.ArrowDown) tryMove(0, 1); else if (keys.ArrowLeft) tryMove(-1, 0); else if (keys.ArrowRight) tryMove(1, 0);
        }
        if (keys[" "] && !keyProcessed[" "] && !player.isMoving && player.interactionCooldown === 0 && !introCutsceneActive && !officeCutsceneActive) {
            keyProcessed[" "] = true; let interact = false;
            const adj = [{x: player.gridX, y: player.gridY - 1}, {x: player.gridX, y: player.gridY + 1}, {x: player.gridX - 1, y: player.gridY}, {x: player.gridX + 1, y: player.gridY}];
            for (let pos of adj) { for (let npc of activeNPCs) { if (npc.gridX === pos.x && npc.gridY === pos.y) { if (npc.heal) player.hp = player.maxHp; startDialogue(npc); interact = true; break; } } if (interact) break; }
        }
    }
    if (currentState === STATE.DIALOGUE) { if (keys[" "] && !keyProcessed[" "] && player.interactionCooldown === 0) { keyProcessed[" "] = true; advanceDialogue(); } if (player.interactionCooldown > 0) player.interactionCooldown--; }
    if (currentState === STATE.BATTLE) updateBattle();
    if (currentState === STATE.PENALTY) updatePenalty();
}
function drawMapScreen() {
    ctx.fillStyle = activeRoom.color || COLORS.floor;
    if (activeRoom.name === "ASTRO TURF") ctx.fillStyle = COLORS.astroFloor;
    else if (activeRoom.name === "PASTORAL OFFICE") ctx.fillStyle = COLORS.pastoralFloor;
    else if (activeRoom.name === "DT BLOCK") ctx.fillStyle = COLORS.dtFloor;
    else if (activeRoom.name === "RS BLOCK") ctx.fillStyle = COLORS.rsFloor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
            const tile = activeMap[y][x];
            if (tile === 1) {
                ctx.fillStyle = COLORS.wall;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#222';
                ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            } else if (tile === 2) { // Door
                drawSprite(ctx, 'door', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            } else if (tile === 3) { // Table
                drawSprite(ctx, 'table', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            } else if (tile === 4) { // Chair
                drawSprite(ctx, 'chair', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            } else if (tile === 5) { // Plant
                drawSprite(ctx, 'plant', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            } else if (tile === 6) { // Altar/Counter
                drawSprite(ctx, 'table', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            } else if (tile === 7) { // Computer
                drawSprite(ctx, 'computer', x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, true);
            }
        }
    }
    // Astro Turf Markings
    if (activeRoom.name === "ASTRO TURF") {
        ctx.strokeStyle = "rgba(255,255,255,0.3)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        // Mid line
        ctx.moveTo(canvas.width/2, 40);
        ctx.lineTo(canvas.width/2, canvas.height-40);
        ctx.stroke();
        // Center circle
        ctx.beginPath();
        ctx.arc(canvas.width/2, canvas.height/2, 50, 0, Math.PI*2);
        ctx.stroke();
    }

    ctx.textAlign = 'center';
    
    // Draw Crowd
    activeCrowd.forEach(c => {
         const drawX = (c.pixelX !== undefined) ? c.pixelX : c.gridX * TILE_SIZE;
         const drawY = (c.pixelY !== undefined) ? c.pixelY : c.gridY * TILE_SIZE;
         const bob = c.isMoving ? (frames / 5) : 0; 
         drawSprite(ctx, c.spriteKey, drawX, drawY, TILE_SIZE, c.facingRight, bob);
    });
    activeMinions.forEach(m => { 
        if(m.active) drawSprite(ctx, m.spriteKey, m.gridX * TILE_SIZE, m.gridY * TILE_SIZE, TILE_SIZE, true); 
    });
    
    activeNPCs.forEach(npc => {
        const drawX = (npc.pixelX !== undefined) ? npc.pixelX : npc.gridX * TILE_SIZE;
        const drawY = (npc.pixelY !== undefined) ? npc.pixelY : npc.gridY * TILE_SIZE;
        const bob = npc.isMoving ? (frames / 5) : 0; 
        
        drawSprite(ctx, npc.spriteKey, drawX, drawY, TILE_SIZE, false, bob);
        
        if (npc.id === 'grant_final' && activeBoss && !activeBoss.active) {
           drawSprite(ctx, 'alert', npc.gridX * TILE_SIZE, (npc.gridY - 1) * TILE_SIZE, TILE_SIZE, false);
        }
    });
    if (activeBoss && activeBoss.active) { 
        drawSprite(ctx, activeBoss.spriteKey, activeBoss.gridX * TILE_SIZE, activeBoss.gridY * TILE_SIZE, 50, false); 
    }
    drawSprite(ctx, player.spriteKey, player.x, player.y, TILE_SIZE, player.facingRight, player.isMoving ? player.bobFrame : 0);
    
    // UI Overlay
    // HP
    ctx.fillStyle = '#fff'; ctx.textAlign = 'left'; ctx.font = '12px "Press Start 2P"';
    ctx.fillText(`HP: ${player.hp}`, 10, 20); 

    // Bug Keys Tracker - Updated to Pastoral, DT, C3
    const pastKey = MAP_LAYOUTS['PASTORAL_OFFICE'].minions.every(m => !m.active);
    const dtKey = MAP_LAYOUTS['DT_BLOCK'].minions.every(m => !m.active);
    const c3Key = MAP_LAYOUTS['CLASSROOM_3'].minions.every(m => !m.active);

    ctx.font = '10px "Press Start 2P"';
    ctx.fillStyle = '#ccc';
    ctx.fillText("KEYS:", 10, 40);

    const drawKey = (x, done, label) => {
        ctx.fillStyle = done ? '#44ff44' : '#444'; // Green if done, dark grey if not
        ctx.fillRect(x, 28, 20, 14);
        ctx.strokeStyle = done ? '#fff' : '#666';
        ctx.strokeRect(x, 28, 20, 14);
        ctx.fillStyle = done ? '#000' : '#aaa';
        ctx.fillText(label, x + 5, 39);
    };

    drawKey(65, pastKey, "A");
    drawKey(90, dtKey, "B");
    drawKey(115, c3Key, "C");
}
function drawBattle() {
    ctx.save();
    if (battleShake > 0) ctx.translate((Math.random()-0.5)*battleShake, (Math.random()-0.5)*battleShake);
    // Background
    ctx.fillStyle = '#f8f8f8'; ctx.fillRect(0,0,800,600); // Light BG
    ctx.fillStyle = '#d0e0f0'; ctx.beginPath(); ctx.moveTo(0,600); ctx.lineTo(800,600); ctx.lineTo(800,300); ctx.lineTo(0,450); ctx.fill(); // Ground
    // Platforms
    ctx.fillStyle = '#c0c0c0'; 
    ctx.beginPath(); ctx.ellipse(580, 200, 120, 40, 0, 0, Math.PI*2); ctx.fill(); // Enemy Base
    ctx.beginPath(); ctx.ellipse(200, 450, 120, 40, 0, 0, Math.PI*2); ctx.fill(); // Player Base
    // Sprites
    
    // Player
    drawSprite(ctx, player.spriteKey, 140, 370, 128, true);
    // Enemy - Handle Fainting Logic
    let enemyY = 120;
    let enemyOpacity = 1.0;
    
    if (battleState === 'FAINT_ANIM') {
        const progress = Math.min(1, faintTimer / 60); // Fade over 1 second
        enemyY += progress * 50;
        enemyOpacity = 1 - progress;
    } else if (battleState === 'VICTORY_WAIT') {
        enemyY += 50; 
        enemyOpacity = 0; 
    }
    
    if (battleState !== 'VICTORY_WAIT') { 
       if (activeBattleEnemy.hp > 0 || battleState === 'FAINT_ANIM') {
           drawSprite(ctx, activeBattleEnemy.spriteKey, 520, enemyY, 128, false, 0, enemyOpacity);
       }
    }
    if (activeBattleEnemy.hp > 0) {
        drawHealthBox(50, 50, activeBattleEnemy.name, activeBattleEnemy.lvl, activeBattleEnemy.hp, activeBattleEnemy.maxHp, false);
    }
    
    drawHealthBox(450, 350, "PLAYER", 13, player.hp, player.maxHp, true);
    battleEffects.forEach(p => {
        if (p.type === 'projectile') { 
            // Draw simple square projectile
            ctx.fillStyle = p.color || '#fff';
            ctx.fillRect(p.x - 10, p.y - 10, 20, 20);
            ctx.strokeStyle = '#000';
            ctx.strokeRect(p.x - 10, p.y - 10, 20, 20);
        }
        else { ctx.font='20px "Press Start 2P"'; ctx.fillStyle=p.color; ctx.fillText(p.text, p.x, p.y); }
    });
    // UI
    ctx.fillStyle = '#222'; ctx.fillRect(0, 480, 800, 120);
    ctx.fillStyle = '#fff'; ctx.lineWidth = 4; ctx.strokeStyle = '#666'; ctx.strokeRect(10, 490, 780, 100); ctx.fillRect(10, 490, 780, 100);
    ctx.fillStyle = '#000'; ctx.textAlign = 'left'; ctx.font = '14px "Press Start 2P"';
    if (battleState === 'MENU') {
        // Dynamic Left Box Text based on Selection
        let desc = "";
        if (battleMenuIdx === 0) desc = "QUESTION: Answer JCQ quiz.";
        else if (battleMenuIdx === 1) desc = "GEN-AI: Risky! (60% Hit / 40% Hurt)";
        else if (battleMenuIdx === 2) desc = "RUN: Escape battle.";
        ctx.fillStyle = '#000'; 
        wrapText(ctx, desc, 35, 535, 350, 20); // Wrapped description
        // Menu Box
        ctx.fillStyle = '#fff'; ctx.strokeStyle = '#000'; ctx.fillRect(400, 490, 390, 100); ctx.strokeRect(400, 490, 390, 100);
        ctx.fillStyle = '#000';
        // Modified Menu Options per Request
        // 0: QUESTION, 1: GEN-AI, 2: RUN
        const opts = ["QUESTION", "GEN-AI", "RUN"];
        ctx.fillText((battleMenuIdx===0?">":" ")+opts[0], 420, 530);
        ctx.fillText((battleMenuIdx===1?">":" ")+opts[1], 620, 530);
        ctx.fillText((battleMenuIdx===2?">":" ")+opts[2], 420, 560);
    } else if (battleState === 'QUESTION') {
        ctx.font = '12px "Press Start 2P"';
        ctx.fillStyle = '#000';
        // Use wrapText for questions too!
        wrapText(ctx, currentQuestion.q, 30, 505, 740, 18);
        
        currentQuestion.options.forEach((o, i) => {
            ctx.fillStyle = i === selectedOptionIdx ? '#d00' : '#000';
            // Ensure options don't clip if wrapping pushes them down (simplified vertical stack)
            let yPos = 545 + (i*20);
            ctx.fillText((i===selectedOptionIdx?"> ":"  ")+o, 30, yPos);
        });
    } else {
        ctx.fillStyle = '#000';
        wrapText(ctx, battleMsg, 35, 535, 740, 20);
        if (battleState === 'VICTORY_WAIT') {
             ctx.fillStyle = '#d00'; 
             ctx.fillText("[PRESS 'A' TO CONTINUE]", 450, 570);
        }
    }
    ctx.restore();
}
function drawHealthBox(x, y, name, lvl, hp, maxHp, showNumbers) {
    // Box Body
    ctx.fillStyle = '#fff'; ctx.strokeStyle='#000'; ctx.lineWidth=3;
    ctx.fillRect(x, y, 300, 80); ctx.strokeRect(x, y, 300, 80);
    
    // Text
    ctx.fillStyle = '#000'; ctx.font = '14px "Press Start 2P"'; ctx.textAlign = 'left';
    ctx.fillText(name, x + 10, y + 30);
    ctx.fillText("Lv" + lvl, x + 220, y + 30);
    // HP Bar
    ctx.fillStyle = '#555'; ctx.fillRect(x + 60, y + 45, 200, 15); // Back
    const pct = Math.max(0, hp / maxHp);
    ctx.fillStyle = pct > 0.5 ? '#4f4' : (pct > 0.2 ? '#fd0' : '#f44');
    ctx.fillRect(x + 60, y + 45, 200 * pct, 15); // Front
    
    ctx.fillStyle = '#000'; ctx.font = '10px "Press Start 2P"'; ctx.fillText("HP", x + 30, y + 57);
    
    if (showNumbers) {
        ctx.fillText(`${Math.floor(hp)}/ ${maxHp}`, x + 150, y + 70);
    }
}
function drawEndScreen() {
    ctx.fillStyle = currentState === STATE.WIN ? '#000' : '#200'; ctx.fillRect(0,0,800,600);
    ctx.textAlign = 'center'; 
    
    if (currentState === STATE.WIN) {
        ctx.font = '30px "Press Start 2P"';
        ctx.fillStyle = '#44ff44';
        ctx.fillText("INTEGRITY RESTORED!", 400, 60);

        ctx.font = '14px "Press Start 2P"';
        ctx.fillStyle = '#ffffff';
        ctx.fillText("Great job! You have purged the glitches.", 400, 110);
        
        ctx.fillStyle = '#f0db4f';
        ctx.fillText("REMEMBER THE AI CODE:", 400, 160);
        
        ctx.textAlign = 'left';
        ctx.fillStyle = '#ffffff';
        ctx.fillText("1. AUTHENTICITY: Your work must be your own.", 80, 210);
        ctx.fillText("2. TRANSPARENCY: Reference AI tools used.", 80, 250);
        ctx.fillText("3. VERIFICATION: Check AI facts.", 80, 290);
        ctx.fillText("4. CONSEQUENCES: Misuse = Disqualification.", 80, 330);
        
        ctx.textAlign = 'center';
        ctx.fillStyle = '#cccccc';
        ctx.fillText("Use AI as a tool, not a replacement.", 400, 380); 
        
        ctx.fillStyle = '#ffffff';
        ctx.fillText("Press 'A' to Restart", 400, 560);

        // Mr Clinton Pop-up (10 seconds = 600 frames at 60fps)
        if (winTimer > 600) {
            // Draw Box
            ctx.fillStyle = '#333';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 4;
            ctx.fillRect(150, 420, 500, 100);
            ctx.strokeRect(150, 420, 500, 100);
            
            // Draw Clinton
            drawSprite(ctx, 'clinton', 170, 440, 60, false);
            
            // Draw Text
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'left';
            ctx.font = '12px "Press Start 2P"';
            ctx.fillText("Mr Clinton:", 250, 450);
            wrapText(ctx, "\"You did a really really brilliant job!\"", 250, 480, 380, 20);
        }

    } else {
        ctx.fillStyle = '#f44';
        ctx.font = '30px "Press Start 2P"';
        ctx.fillText("GAME OVER", 400, 250);
        ctx.fillStyle = '#fff'; ctx.font = '14px "Press Start 2P"';
        ctx.fillText(battleMsg, 400, 320);
        ctx.fillText("Press 'A' to restart.", 400, 450);
    }
}
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (currentState === STATE.TRANSITION) { drawMapScreen(); const p = 1 - (transitionTimer / 90); const h = (canvas.height / 2) * p; ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, h); ctx.fillRect(0, canvas.height - h, canvas.width, h); if (transitionTimer % 4 < 2) { ctx.fillStyle = 'rgba(255, 255, 255, 0.5)'; ctx.fillRect(0, 0, canvas.width, canvas.height); } return; }
    if (currentState === STATE.BATTLE) { drawBattle(); return; }
    if (currentState === STATE.PENALTY) { drawPenalty(); return; }
    if (currentState === STATE.WIN || currentState === STATE.GAMEOVER) { drawEndScreen(); return; }
    drawMapScreen();
}
window.addEventListener('keydown', e => { if ((currentState === STATE.WIN || currentState === STATE.GAMEOVER) && e.key === " ") location.reload(); });
function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
